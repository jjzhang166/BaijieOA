BjPage
{
AdjustFrame:0
BeforeCreate:""
BodyProp:""
BootstrapVer:2
Caption:添加文件
Enabled:1
Name:BjPage1
PageID:FP1EE6B1623225440D9F9F12D55FC2FB9D
ParenClass:""
Visible:1
Workflow:0
Position
{
Height:600
Left:83
Top:121
Width:800
}
Events
{
Def:""
OnLoad:""
}
@
{
EasyScript
{
Caption:设置页面参数
Code:"me.PageParam.IsOrg = int(me._vo.isorg);
me.PageParam.IsShare = int(me._vo.isshare);
me.PageParam.UserID = me.会话.UserID;
me.PageParam.DocID = int(me._vo.id);
me.PageParam.DocCat = (me.PageParam.IsOrg ? \"单位文档\" : ( me.PageParam.IsShare ? \"共享文档\": \"个人文档\"));"
CodeType:load
Name:EasyScript2
Position
{
Height:20
Left:24
Top:-38
Width:80
}
}
EasyScript
{
Caption:设置二级菜单
Code:"
me.ControlProp[\"二级菜单/Active\"] = me.PageParam.DocCat;

if( !me.PageParam.IsOrg && !me.PageParam.IsShare && me.PageParam.UserID <> me.会话.UserID ) 
	throw \"未授权的访问\";"
CodeType:load
Name:EasyScript1
Position
{
Height:20
Left:176
Top:-38
Width:80
}
}
UserControl
{
BeforeCreate:""
Caption:""
Enabled:1
Name:UserControl1
PathName:"/template/基础功能.ui"
Visible:1
Position
{
Height:1124
Left:52
Top:23
Width:1230
}
@
{
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:BaseClient
TagName:""
Visible:1
Position
{
Height:1080
Left:21
Top:23
Width:1068
}
@
{
BjSubmitArea
{
Action:""
BeforeCreate:""
Caption:""
FileUpload:1
Horz:0
ID:""
Inline:0
Method:post
Name:BjSubmitArea1
Search:0
Position
{
Height:1038
Left:22
Top:24
Width:1032
}
@
{
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:Box1
TagName:""
Visible:1
Position
{
Height:134
Left:16
Top:15
Width:985
}
@
{
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:Box3
TagName:""
Visible:1
Position
{
Height:78
Left:16
Top:11
Width:541
}
@
{
html_image
{
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"style=\"float:left;margin-top:7px\""
Name:html_image_1
Visible:1
src:"<% echo(FixUrl(\"/images/bankuaijiantou.gif\")); %>"
Position
{
Height:45
Left:13
Top:14
Width:50
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"style=\"float:left;\""
ID:""
Name:Box5
TagName:span
Visible:1
Position
{
Height:55
Left:76
Top:14
Width:435
}
@
{
BjBreadcrumbNav
{
BeforeCreate:""
ExtProp:"style=\"background-Color:white;padding:2px;margin:2px\" "
Name:BjBreadcrumbNav1
Position
{
Height:40
Left:11
Top:5
Width:411
}
@
{
BjBreadcrumb
{
Active:""
BeforeCreate:""
Caption:桌面
Divider:"/"
Enabled:1
Name:BjBreadcrumb1
Visible:1
href:"<%echo(FixUrl(\"/main/mydesk.esh\"));%>"
Position
{
Height:20
Left:9
Top:12
Width:80
}
}
BjBreadcrumb
{
Active:""
BeforeCreate:""
Caption:"<% echo(me.PageParam.DocCat);%>"
Divider:"/"
Enabled:1
Name:BjBreadcrumb2
Visible:1
href:"<% echo( me.PageParam.DocCat == \"个人文档\" ? \"personaldoc.esh\" : (me.PageParam.DocCat ==\"单位文档\" ? \"orgdoc.esh\":\"sharedoc.esh\")); %>"
Position
{
Height:20
Left:107
Top:12
Width:131
}
}
BjBreadcrumb
{
Active:""
BeforeCreate:""
Caption:添加文件
Divider:""
Enabled:1
Name:BjBreadcrumb1
Visible:1
href:""
Position
{
Height:20
Left:254
Top:12
Width:80
}
}
}
}
}
}
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"class=\"clearfix\" style=\"margin-bottom:5px\""
ID:""
Name:Box6
TagName:""
Visible:1
Position
{
Height:22
Left:16
Top:103
Width:493
}
}
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"class=\"line\" style=\"magrin-top:5px;margin-bottom:5px;\""
ID:""
Name:Box2
TagName:""
Visible:1
Position
{
Height:30
Left:16
Top:161
Width:985
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:Box4
TagName:""
Visible:1
Position
{
Height:593
Left:16
Top:208
Width:1000
}
@
{
EasyScript
{
Caption:""
Code:"
public var _Erroroa__Hint=\"\";
public var _Successoa__Hint=\"\";
"
CodeType:server
Name:esvar_oa_gonggao
Position
{
Height:20
Left:24
Top:36
Width:80
}
}
ConditionControl
{
Action:"me._Erroroa__Hint <> \"\""
BeforeCreate:""
Method:if
Name:errconditionoa_gonggao
Position
{
Height:80
Left:24
Top:66
Width:338
}
@
{
BjAlertBox
{
BeforeCreate:""
CanClose:1
Caption:""
Enabled:1
ID:""
Level:error
Multi:1
Name:errAlertoa_gonggao
Visible:1
Position
{
Height:60
Left:10
Top:10
Width:300
}
@
{
Html
{
BeforeCreate:""
Caption:错误提示_oa_gonggao
Code:"<% echo(me._Erroroa__Hint); %>"
Name:errHtml_oa_gonggao
Position
{
Height:20
Left:10
Top:10
Width:80
}
}
}
}
}
}
ConditionControl
{
Action:"me._Successoa__Hint <> \"\""
BeforeCreate:""
Method:if
Name:successconditionoa_gonggao
Position
{
Height:80
Left:24
Top:156
Width:338
}
@
{
BjAlertBox
{
BeforeCreate:""
CanClose:1
Caption:""
Enabled:1
ID:""
Level:success
Multi:1
Name:successAlertoa_gonggao
Visible:1
Position
{
Height:60
Left:10
Top:10
Width:300
}
@
{
Html
{
BeforeCreate:""
Caption:成功提示_oa_gonggao
Code:"<% echo(me._Successoa__Hint); %>"
Name:successHtml_oa_gonggao
Position
{
Height:20
Left:10
Top:10
Width:80
}
}
}
}
}
}
BjEdit
{
BeforeCreate:""
Caption:id
Enabled:1
ID:""
Inline:0
IsMultiline:0
IsPassword:0
Name:id
PlaceHolder:""
Search:0
Size:none
Value:"<% echo(me.PageParam.DocID); %>"
Visible:0
Wide:none
cols:""
rows:""
Position
{
Height:20
Left:101
Top:16
Width:80
}
InfoStatus
{
Condition:""
Text:""
}
WarnStatus
{
Condition:""
Text:""
}
ErrorStatus
{
Condition:""
Text:""
}
SuccessStatus
{
Condition:""
Text:""
}
Events
{
OnSearch:""
}
Validate
{
DisplayName:""
Format:""
MaxLength:0
MustFill:0
}
}
BjEdit
{
BeforeCreate:""
Caption:父目录：
Enabled:0
ID:""
Inline:0
IsMultiline:0
IsPassword:0
Name:BjEdit1
PlaceHolder:""
Search:0
Size:none
Value:"<%
{
	var docid = int(me.PageParam.DocID);
	var docs=[];
	while(docid <> 0 )
	{
		var obj = (new dao.table(\"t_doc_file\")).Single(\"select id,pid,name from t_doc_file where isdeleted=0 and isfolder=1 and id=?\",docid);
		docs.Add( obj.name );
		docid = int(obj.pid);
	}
	var a = [\"/\"];
	var iCount = docs.Count;
	for(var i=iCount-1;i>=0;i--) a.Add(docs[i],\"/\");
	echo(a);
}
%>"
Visible:1
Wide:none
cols:""
rows:""
Position
{
Height:20
Left:101
Top:245
Width:80
}
InfoStatus
{
Condition:""
Text:""
}
WarnStatus
{
Condition:""
Text:""
}
ErrorStatus
{
Condition:""
Text:""
}
SuccessStatus
{
Condition:""
Text:""
}
Events
{
OnSearch:""
}
Validate
{
DisplayName:""
Format:""
MaxLength:0
MustFill:0
}
}
BjEdit
{
BeforeCreate:""
Caption:文件描述：
Enabled:1
ID:""
Inline:0
IsMultiline:1
IsPassword:0
Name:desc
PlaceHolder:""
Search:0
Size:none
Value:""
Visible:1
Wide:none
cols:""
rows:""
Position
{
Height:85
Left:101
Top:285
Width:151
}
InfoStatus
{
Condition:""
Text:""
}
WarnStatus
{
Condition:""
Text:""
}
ErrorStatus
{
Condition:""
Text:""
}
SuccessStatus
{
Condition:""
Text:""
}
Events
{
OnSearch:""
}
Validate
{
DisplayName:描述
Format:""
MaxLength:1024
MustFill:0
}
}
Html
{
BeforeCreate:""
Caption:""
Code:"<label for=\"upfile\">文件：</label>
<input name=\"UpLoadFile\" id=\"upfile\" type=\"file\" /> 
<div class=\"panel\" style=\"margin-top:10px\">您可以上传文本文件、图像文件、视频文件、压缩文件、office文件等，文件最大为20MB</div>"
Name:Html1
Position
{
Height:30
Left:44
Top:421
Width:269
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"style=\"margin-top:10px;margin-bottom:10px\""
ID:""
Name:Box8
TagName:""
Visible:1
Position
{
Height:49
Left:44
Top:514
Width:347
}
@
{
BjButton
{
BeforeCreate:""
Block:0
ButtonType:submit
Caption:"<i class=\"icon-ok icon-white\" style=\"margin-right:5px\" ></i>提交"
Enabled:1
Feedback:danger
ID:""
Inline:1
Name:btnsubmit_oa_workrizhi
Size:default
URL:""
URLParam:""
Visible:1
Position
{
Height:20
Left:13
Top:9
Width:80
}
Events
{
OnClick:"
var file;
var sFileName=\"\";

var sExt=\"\";
try
{
	if( me._vo.desc.Length > 1024 ) throw \"输入的数据长度超过了描述的限制\";

	//-----文件处理
	file = me._vo.UpLoadFile;
	if( int(file.Length) > 1024 * 1024 * 20 ) 
		throw(\"文件大小超过限制\");
	sFileName = file.FileName;
	var iPos = sFileName.ReverseFind(\".\");
	if( iPos < 0 ) throw(\"文件类型非法\");
	sExt = sFileName.Right(sFileName.Length-iPos-1).ToLower();
	var validext=(new dao.table(\"t_doc_filetype\")).Single(\"select ext from t_doc_filetype where ext=?\",sExt);
	
	if( validext == null )
		throw(\"文件类型(\"+sExt+\")不符合要求\");
}
catch (ex)
{
	me._Erroroa__Hint= string(ex);
	return;
}
var url = me.PageParam.DocCat == \"个人文档\" ? \"personaldoc.esh\" : (me.PageParam.DocCat ==\"单位文档\" ? \"orgdoc.esh\":\"sharedoc.esh\");
url += \"&id=\"+me.PageParam.DocID;

var n = \"\"+(new helper()).Random() % 10000;
var sNewFile=\"\";
each(a,n) sNewFile += \"/\"+a;
//var sAttachPath = (new website()).attachpath;
//if( sAttachPath.Right(1) == \"\\\" ) sAttachPath = sAttachPath.Left( sAttachPath.Length - 1 );
sNewFile += \"/\"+(new helper()).NewGUID();//sAttachPath + sNewFile + \"\\\"+(new helper()).NewGUID();
sNewFile += \".\"+sExt;
file.WriteToFile(sNewFile);


(new log()).Infor(\"filename=\"+sFileName);

var ext = (new dao.table(\"t_doc_filetype\")).Single(\"select id from t_doc_filetype where ext=?\",sExt);
if( ext == null ) ext = (new dao.table(\"t_doc_filetype\")).Single(\"select id from t_doc_filetype where ext=?\",\"?\");
var obj=
{
	
	\"pid\"			: me._vo.id,
	\"name\"			: sFileName,
	\"desc\"			: me._vo.desc,
	\"size\"			: file.Length,
	\"createtime\"		: new DateTime(),
	\"createuser\"		: me.会话.UserID,
	\"filetype\"		: (ext <> null ? ext.id : 0),
	\"isshare\"		: me._vo.isshare,
	\"isorg\"			: me._vo.isorg,
	\"isfolder\"		: 0,
	\"filepath\"		: sNewFile

};

(new dao.table(\"t_doc_file\")).Add(obj);
me._Successoa__Hint = \"添加成功\";

redirect( url );
"
OnClientClick:""
}
}
BjButton
{
BeforeCreate:""
Block:0
ButtonType:back
Caption:"<i class=\"icon-repeat \" style=\"margin-right:5px\" ></i>返回"
Enabled:1
Feedback:default
ID:""
Inline:1
Name:btncancel_oa_workrizhi
Size:default
URL:""
URLParam:""
Visible:1
Position
{
Height:20
Left:113
Top:11
Width:80
}
Events
{
OnClick:""
OnClientClick:""
}
}
}
}
BjEdit
{
BeforeCreate:""
Caption:isorg
Enabled:1
ID:""
Inline:0
IsMultiline:0
IsPassword:0
Name:BjEdit2
PlaceHolder:""
Search:0
Size:none
Value:"<% echo(me.PageParam.IsOrg); %>"
Visible:0
Wide:none
cols:""
rows:""
Position
{
Height:20
Left:217
Top:16
Width:80
}
InfoStatus
{
Condition:""
Text:""
}
WarnStatus
{
Condition:""
Text:""
}
ErrorStatus
{
Condition:""
Text:""
}
SuccessStatus
{
Condition:""
Text:""
}
Events
{
OnSearch:""
}
Validate
{
DisplayName:""
Format:""
MaxLength:0
MustFill:0
}
}
BjEdit
{
BeforeCreate:""
Caption:isshare
Enabled:1
ID:""
Inline:0
IsMultiline:0
IsPassword:0
Name:BjEdit3
PlaceHolder:""
Search:0
Size:none
Value:"<% echo(me.PageParam.IsShare); %>"
Visible:0
Wide:none
cols:""
rows:""
Position
{
Height:20
Left:337
Top:16
Width:80
}
InfoStatus
{
Condition:""
Text:""
}
WarnStatus
{
Condition:""
Text:""
}
ErrorStatus
{
Condition:""
Text:""
}
SuccessStatus
{
Condition:""
Text:""
}
Events
{
OnSearch:""
}
Validate
{
DisplayName:""
Format:""
MaxLength:0
MustFill:0
}
}
}
}
}
}
}
}
}
}
}
}
