BjPage
{
AdjustFrame:0
BeforeCreate:""
BodyProp:""
BootstrapVer:2
Caption:设置角色权限
Enabled:1
Name:BjPage1
PageID:""
ParenClass:""
Visible:1
Workflow:0
Position
{
Height:1100
Left:38
Top:59
Width:800
}
Events
{
Def:""
OnLoad:""
}
@
{
EasyScript
{
Caption:设置二级菜单
Code:"me.ControlProp[\"二级菜单/Active\"] = \"角色设置\";"
CodeType:load
Name:EasyScript1
Position
{
Height:20
Left:10
Top:-31
Width:80
}
}
UserControl
{
BeforeCreate:""
Caption:""
Enabled:1
Name:UserControl1
PathName:"/template/webmanagetemp.ui"
Visible:1
Position
{
Height:1007
Left:43
Top:38
Width:1331
}
@
{
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:SettingClient
TagName:""
Visible:1
Position
{
Height:829
Left:18
Top:25
Width:1257
}
@
{
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:Box1
TagName:""
Visible:1
Position
{
Height:202
Left:20
Top:22
Width:1210
}
@
{
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:Box3
TagName:""
Visible:1
Position
{
Height:78
Left:16
Top:11
Width:537
}
@
{
html_image
{
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"style=\"float:left;margin-top:7px\""
Name:html_image_1
Visible:1
src:"<% echo(FixUrl(\"/images/bankuaijiantou.gif\")); %>"
Position
{
Height:45
Left:13
Top:14
Width:50
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"style=\"float:left;\""
ID:""
Name:Box5
TagName:span
Visible:1
Position
{
Height:55
Left:76
Top:14
Width:446
}
@
{
BjBreadcrumbNav
{
BeforeCreate:""
ExtProp:"style=\"background-Color:white;padding:2px;margin:2px\" "
Name:BjBreadcrumbNav1
Position
{
Height:40
Left:11
Top:5
Width:409
}
@
{
BjBreadcrumb
{
Active:""
BeforeCreate:""
Caption:桌面
Divider:"/"
Enabled:1
Name:BjBreadcrumb1
Visible:1
href:"<%echo(FixUrl(\"/main/mydesk.esh\"));%>"
Position
{
Height:20
Left:9
Top:12
Width:80
}
}
BjBreadcrumb
{
Active:""
BeforeCreate:""
Caption:系统设置
Divider:"/"
Enabled:1
Name:BjBreadcrumb2
Visible:1
href:"<%echo(FixUrl(\"/webmanage/main.esh\"));%>"
Position
{
Height:20
Left:101
Top:12
Width:80
}
}
BjBreadcrumb
{
Active:""
BeforeCreate:""
Caption:角色设置
Divider:"/"
Enabled:1
Name:BjBreadcrumb3
Visible:1
href:role.esh
Position
{
Height:20
Left:200
Top:12
Width:80
}
}
BjBreadcrumb
{
Active:""
BeforeCreate:""
Caption:权限设置
Divider:""
Enabled:1
Name:BjBreadcrumb3
Visible:1
href:""
Position
{
Height:20
Left:299
Top:12
Width:80
}
}
}
}
}
}
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"style=\"float:right\""
ID:""
Name:Box4
TagName:""
Visible:1
Position
{
Height:108
Left:613
Top:11
Width:561
}
@
{
BjButton
{
BeforeCreate:""
Block:0
ButtonType:back
Caption:"<i class=\"icon-repeat \" style=\"margin-right:5px\" ></i>返回"
Enabled:1
Feedback:default
ID:""
Inline:1
Name:BjButton2
Size:default
URL:""
URLParam:""
Visible:1
Position
{
Height:20
Left:296
Top:22
Width:80
}
Events
{
OnClick:""
OnClientClick:""
}
}
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"class=\"clearfix\" style=\"margin-bottom:5px\""
ID:""
Name:Box6
TagName:""
Visible:1
Position
{
Height:22
Left:16
Top:156
Width:493
}
}
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"class=\"line\" style=\"magrin-top:5px;margin-bottom:5px;\""
ID:""
Name:Box2
TagName:""
Visible:1
Position
{
Height:30
Left:20
Top:245
Width:985
}
}
BjDataGrid
{
BeforeCreate:"
if( roleSelected.Count < 1 ) me.ErrorAndRedirect(\"请先选择角色！\",\"role.esh\");"
Caption:将要给以下角色：
DeleteUrl:role.esh
DellHint:确定删除选定的项？
EditUrl:role_edit.esh
Enabled:1
MaxPage:9
Name:t_role
PageSize:10
URLParam:""
URLParamDel:""
UsePager:0
Visible:1
Position
{
Height:104
Left:20
Top:296
UseHeight:0
UseWidth:0
Width:701
}
Events
{
CanDelete:"return true;"
CanEdit:"return true;"
CanSelect:"return true;"
OnGetData:"var str=\"(\";
var bFirst = true;
each(a,roleSelected)
{
	if( !bFirst )
	{
		str += \",\";
	}
	else
		bFirst = false;
	str += a;
}
str += \")\";



//当前页数据
var datas = null;

datas= (new dao.table(\"t_role\")).Query(
				\"where id in \"+str+\" and isdeleted=0 \"
				);
each(a,datas)
{
	var iType = a.roletype;
	a.roletype = staticcall(\"模型.组织.角色.角色类型.Text\",a.roletype);
	if( iType == const \"模型.组织.角色.角色类型.部门\" )
	{
		var obj = (new dao.table(\"t_unit\")).Single(\"select name from t_unit where id=?\",int(a.unitid));
		a.unitid = obj.name;
	}
	else
		a.unitid=\"N/A\";
}

return datas;
"
OnGetTotalPage:"return 1;"
}
@
{
BjDataGridColumn
{
BeforeCreate:""
CanView:0
Caption:"#"
Enabled:1
Field:""
IsKey:0
IsOperator:0
IsSerial:1
Name:""
StaticUrl:0
ViewUrl:""
Visible:1
Position
{
Height:20
Left:10
Top:10
Width:20
}
}
BjDataGridColumn
{
BeforeCreate:""
CanView:0
Caption:id
Enabled:1
Field:id
IsKey:1
IsOperator:0
IsSerial:0
Name:id
StaticUrl:0
ViewUrl:""
Visible:0
Position
{
Height:20
Left:53
Top:10
Width:78
}
}
BjDataGridColumn
{
BeforeCreate:""
CanView:0
Caption:名称
Enabled:1
Field:name
IsKey:0
IsOperator:0
IsSerial:0
Name:name
StaticUrl:0
ViewUrl:""
Visible:1
Position
{
Height:20
Left:140
Top:10
Width:78
}
}
BjDataGridColumn
{
BeforeCreate:""
CanView:0
Caption:描述
Enabled:1
Field:desc
IsKey:0
IsOperator:0
IsSerial:0
Name:desc
StaticUrl:0
ViewUrl:""
Visible:1
Position
{
Height:20
Left:246
Top:10
Width:78
}
}
BjDataGridColumn
{
BeforeCreate:""
CanView:0
Caption:角色类型
Enabled:1
Field:roletype
IsKey:0
IsOperator:0
IsSerial:0
Name:roletype
StaticUrl:0
ViewUrl:""
Visible:1
Position
{
Height:20
Left:344
Top:10
Width:78
}
}
BjDataGridColumn
{
BeforeCreate:""
CanView:0
Caption:部门
Enabled:1
Field:unitid
IsKey:0
IsOperator:0
IsSerial:0
Name:unitid
StaticUrl:0
ViewUrl:""
Visible:1
Position
{
Height:20
Left:436
Top:11
Width:78
}
}
}
}
BjSubmitArea
{
Action:""
BeforeCreate:""
Caption:""
FileUpload:0
Horz:0
ID:""
Inline:0
Method:post
Name:BjSubmitArea1
Search:0
Position
{
Height:300
Left:20
Top:421
Width:900
}
@
{
BjDataGrid
{
BeforeCreate:""
Caption:分配以下权限
DeleteUrl:""
DellHint:""
EditUrl:""
Enabled:1
MaxPage:9
Name:rightgrid
PageSize:20
URLParam:""
URLParamDel:""
UsePager:0
Visible:1
Position
{
Height:104
Left:22
Top:21
UseHeight:0
UseWidth:0
Width:700
}
Events
{
CanDelete:"return false;"
CanEdit:"return false;"
CanSelect:"return true;"
OnGetData:"var Roles = me.会话.Roles;
var strRoleCond = \"\";
{
	var bFirst = true;
	each(a,Roles)
	{
		if( bFirst ) bFirst = false;
		else strRoleCond += \",\";
		strRoleCond += a.ID;
	}
}

var oSuper = (new dao.table(\"t_role_predefine\")).Single(\"where role=? and userid=?\",\"$系统管理员\",int(me.会话.UserID) );
var datas; 
if( null <> oSuper )
	datas = (new dao.table(\"t_sysfunc\")).Query(\"where 1=1 order by pid\");
else
	datas = (new dao.table(\"t_sysfunc\")).Query(
		\"where id in (select funcid from t_role_func where roleid in \"+(\"\" == strRoleCond ? \"(0)\":\"(\"+strRoleCond+\")\")+\") order by pid\"
		);
each(a,datas)
{
	if( a.displayname == \"\" ) a.displayname = a.name;
}
		
return datas;"
OnGetTotalPage:"return 1;"
}
@
{
BjDataGridColumn
{
BeforeCreate:""
CanView:0
Caption:"#"
Enabled:1
Field:""
IsKey:0
IsOperator:0
IsSerial:1
Name:""
StaticUrl:0
ViewUrl:""
Visible:1
Position
{
Height:20
Left:20
Top:20
Width:20
}
}
BjDataGridColumn
{
BeforeCreate:""
CanView:0
Caption:""
Enabled:1
Field:""
IsKey:0
IsOperator:1
IsSerial:0
Name:""
StaticUrl:0
ViewUrl:""
Visible:1
Position
{
Height:20
Left:50
Top:20
Width:20
}
}
BjDataGridColumn
{
BeforeCreate:""
CanView:0
Caption:id
Enabled:1
Field:id
IsKey:1
IsOperator:0
IsSerial:0
Name:id
StaticUrl:0
ViewUrl:""
Visible:0
Position
{
Height:20
Left:80
Top:20
Width:78
}
}
BjDataGridColumn
{
BeforeCreate:""
CanView:0
Caption:名称
Enabled:1
Field:displayname
IsKey:0
IsOperator:0
IsSerial:0
Name:displayname
StaticUrl:0
ViewUrl:""
Visible:1
Position
{
Height:20
Left:168
Top:20
Width:78
}
}
BjDataGridColumn
{
BeforeCreate:""
CanView:0
Caption:描述
Enabled:1
Field:desc
IsKey:0
IsOperator:0
IsSerial:0
Name:desc
StaticUrl:0
ViewUrl:""
Visible:1
Position
{
Height:20
Left:256
Top:20
Width:78
}
}
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"style=\"margin-top:10px;margin-bottom:10px\""
ID:""
Name:Box8
TagName:""
Visible:1
Position
{
Height:49
Left:22
Top:159
Width:347
}
@
{
BjButton
{
BeforeCreate:""
Block:0
ButtonType:submit
Caption:"<i class=\"icon-ok icon-white\" style=\"margin-right:5px\" ></i>提交"
Enabled:1
Feedback:danger
ID:""
Inline:1
Name:btnsubmit_oa_workrizhi
Size:default
URL:""
URLParam:""
Visible:1
Position
{
Height:20
Left:13
Top:9
Width:80
}
Events
{
OnClick:"/* ====权限设置注意点 ==============
1. 只能给自己创建的角色设置权限，别人创建的角色不可以进行权限设置
2. 只能将自己拥有的权限赋给角色，不能越权进行设置
*/

//先得到所有自己拥有的权限
var Roles = me.会话.Roles;
var strRoleCond = \"(\";
{
	var bFirst = true;
	each(a,Roles)
	{
		if( bFirst ) bFirst = false;
		else strRoleCond += \",\";
		strRoleCond += a.ID;
	}
}
strRoleCond += \")\";

var myRights = (new dao.table(\"t_sysfunc\")).Query(
		\"where id in (select funcid from t_role_func where roleid in \"+strRoleCond+\") order by pid\"
		);
	

me.BeginTrans();

//得到界面上勾选的权限
var aRight = (new grid.Selected(\"rightgrid\")).Values();

//针对每一个选中的角色
var aRoleSelected = me._vo.roles.Split(\"|\");
each(r,aRoleSelected)
{
	var roleid = int(r);
	if( roleid > 0 )
	{
		//逐个权限进行判断有没有勾选上，没勾就表示取消权限，有勾就表示增加权限
		each(mr,myRights)
		{
			//(roleid,mr.id) = (角色ID，权限ID)
			var bSelected=false;
			each(nRight,aRight)
			{
				if( int(mr.id) == int(nRight) )
				{
					bSelected = true;
					break;
				}
			}
			if( bSelected )
			{
				//有选上，则增加权限
				var oExists = (new dao.table(\"t_role_func\")).Single(\"where roleid=? and funcid=?\",roleid,int(mr.id));
				if( oExists == null )
					(new dao.table(\"t_role_func\")).Add({
							\"roleid\" : roleid,
							\"funcid\" : int(mr.id)
							});
			}
			else
			{
				//没选上，则取消权限
				(new dao.table(\"t_role_func\")).Delete(\"roleid\",roleid,\"funcid\",mr.id);
			}
		}
		
	}
}
	


me.CommitTrans();

redirect(\"role.esh\");"
OnClientClick:""
}
}
BjButton
{
BeforeCreate:""
Block:0
ButtonType:back
Caption:"<i class=\"icon-repeat \" style=\"margin-right:5px\" ></i>返回"
Enabled:1
Feedback:default
ID:""
Inline:1
Name:btncancel_oa_workrizhi
Size:default
URL:""
URLParam:""
Visible:1
Position
{
Height:20
Left:113
Top:11
Width:80
}
Events
{
OnClick:""
OnClientClick:""
}
}
}
}
BjEdit
{
BeforeCreate:""
Caption:"roles:"
Enabled:1
ID:""
Inline:0
IsMultiline:0
IsPassword:0
Name:roles
PlaceHolder:""
Search:0
Size:none
Value:"<%
{
	var str = \"\";
	each(a,roleSelected)
	{
		str += \"|\"+a;
	}
	echo(str);
}

%>"
Visible:0
Wide:none
cols:0
rows:0
Position
{
Height:20
Left:432
Top:157
Width:80
}
InfoStatus
{
Condition:""
Text:""
}
WarnStatus
{
Condition:""
Text:""
}
ErrorStatus
{
Condition:""
Text:""
}
SuccessStatus
{
Condition:""
Text:""
}
Events
{
OnSearch:""
}
Validate
{
DisplayName:""
Format:""
MaxLength:0
MustFill:0
}
}
}
}
}
}
}
}
EasyScript
{
Caption:""
Code:"public var roleSelected = (new grid.Selected(\"t_role\")).Values();"
CodeType:server
Name:EasyScript2
Position
{
Height:20
Left:118
Top:-31
Width:80
}
}
}
}
