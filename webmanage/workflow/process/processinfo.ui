BjPage
{
AdjustFrame:0
BeforeCreate:""
BodyProp:""
BootstrapVer:2
Caption:进程信息
Enabled:1
Name:BjPage1
PageID:FP5366E6E297F447DED1A1A944F99EFDCD
ParenClass:""
Visible:1
Workflow:0
Position
{
Height:1300
Left:94
Top:88
Width:800
}
Events
{
Def:""
OnLoad:""
}
@
{
EasyScript
{
Caption:设置二级菜单
Code:"me.ControlProp[\"二级菜单/Active\"] = \"进程管理\";"
CodeType:load
Name:EasyScript1
Position
{
Height:20
Left:10
Top:-35
Width:80
}
}
UserControl
{
BeforeCreate:""
Caption:""
Enabled:1
Name:UserControl1
PathName:"/template/webmanagetemp.ui"
Visible:1
Position
{
Height:1262
Left:40
Top:24
Width:948
}
@
{
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:SettingClient
TagName:""
Visible:1
Position
{
Height:1201
Left:16
Top:20
Width:906
}
@
{
BjSubmitArea
{
Action:""
BeforeCreate:"var oCurProcess = staticcall(\"Workflow.Model.Process.Load\",me._vo.id);
var oApp = staticcall(\"Workflow.Model.Application.Load\",oCurProcess.AppName,oCurProcess.AppVer); 
"
Caption:""
ExtProp:""
FileUpload:0
Horz:0
ID:""
Inline:0
Method:post
Name:BjSubmitArea1
Search:0
Position
{
Height:1235
Left:21
Top:16
Width:872
}
@
{
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:Box1
TagName:""
Visible:1
Position
{
Height:162
Left:34
Top:42
Width:985
}
@
{
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:Box3
TagName:""
Visible:1
Position
{
Height:78
Left:16
Top:11
Width:423
}
@
{
html_image
{
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"style=\"float:left;margin-top:7px\""
Name:html_image_1
Visible:1
src:"<% echo(FixUrl(\"/images/bankuaijiantou.gif\")); %>"
Position
{
Height:45
Left:13
Top:14
Width:50
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"style=\"float:left;\""
ID:""
Name:Box5
TagName:span
Visible:1
Position
{
Height:55
Left:76
Top:14
Width:331
}
@
{
BjBreadcrumbNav
{
BeforeCreate:""
ExtProp:"style=\"background-Color:white;padding:2px;margin:2px\" "
Name:BjBreadcrumbNav1
Position
{
Height:40
Left:11
Top:5
Width:307
}
@
{
BjBreadcrumb
{
Active:""
BeforeCreate:""
Caption:桌面
Divider:"/"
Enabled:1
Name:BjBreadcrumb1
Visible:1
href:"<%echo(FixUrl(\"/main/mydesk.esh\"));%>"
Position
{
Height:20
Left:9
Top:12
Width:80
}
}
BjBreadcrumb
{
Active:""
BeforeCreate:""
Caption:进程管理
Divider:"/"
Enabled:1
Name:BjBreadcrumb2
Visible:1
href:list.esh
Position
{
Height:20
Left:97
Top:12
Width:80
}
}
BjBreadcrumb
{
Active:""
BeforeCreate:""
Caption:进程详情
Divider:""
Enabled:1
Name:BjBreadcrumb2
Visible:1
href:""
Position
{
Height:20
Left:189
Top:12
Width:80
}
}
}
}
}
}
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"style=\"float:right\""
ID:""
Name:Box4
TagName:""
Visible:1
Position
{
Height:89
Left:613
Top:11
Width:320
}
@
{
BjButton
{
BeforeCreate:""
Block:0
ButtonType:back
Caption:"<i class=\"icon-repeat \" style=\"margin-right:5px\" ></i>返回"
Enabled:1
Feedback:default
ID:""
Inline:1
Name:BjButton2
Size:default
URL:""
URLParam:""
Visible:1
Position
{
Height:20
Left:112
Top:39
Width:80
}
Events
{
OnClick:""
OnClientClick:""
}
}
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"class=\"clearfix\" style=\"margin-bottom:5px\""
ID:""
Name:Box6
TagName:""
Visible:1
Position
{
Height:22
Left:0
Top:132
Width:493
}
}
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"class=\"line\" style=\"magrin-top:5px;margin-bottom:5px;\""
ID:""
Name:Box2
TagName:""
Visible:1
Position
{
Height:30
Left:34
Top:216
Width:985
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:Box2
TagName:""
Visible:1
Position
{
Height:400
Left:34
Top:264
Width:800
}
@
{
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"style=\"margin-bottom:5px\""
ID:""
Name:Box1
TagName:""
Visible:1
Position
{
Height:67
Left:19
Top:25
Width:646
}
@
{
Html
{
BeforeCreate:""
Caption:"进程基本信息 -- head"
Code:"<div style=\"float:left;height:37px;width:130px;border-bottom:solid 3px RGB(252,139,1)\">
<h4>进程基本信息</h4>
</div>
<div style=\"margin-left:90px;height:37px;border-bottom:solid 3px RGB(73,106,182)\">

</div>"
Name:Html1
Position
{
Height:20
Left:20
Top:19
Width:172
}
}
}
}
BjTable
{
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:BjTable1
Visible:1
border:0
condensed:1
forsthead:0
hover:1
striped:0
Position
{
AutoHeight:""
AutoWidth:""
Height:231
HeightPercent:""
Left:21
Top:108
Width:542
WidthPercent:""
}
@
{
BjRow
{
BeforeCreate:""
Caption:""
Enabled:1
Expr:""
ExtProp:""
Name:""
Visible:1
contextual:none
Position
{
AutoHeight:""
AutoWidth:""
Height:44
HeightPercent:""
Left:0
Top:0
Width:542
WidthPercent:""
}
@
{
BjCell
{
BeforeCreate:""
Caption:""
ColSpan:1
Enabled:1
ExtProp:"style=\"width:120px;\""
Name:""
RowSpan:1
Spaned:0
Visible:1
contextual:none
Position
{
AutoHeight:""
AutoWidth:""
Height:44
HeightPercent:""
Left:0
Top:0
Width:158
WidthPercent:""
}
@
{
Html
{
BeforeCreate:""
Caption:流程
Code:"<b>流程</b>"
Name:Html2
Position
{
Height:20
Left:30
Top:10
Width:80
}
}
}
}
BjCell
{
BeforeCreate:""
Caption:""
ColSpan:1
Enabled:1
ExtProp:""
Name:""
RowSpan:1
Spaned:0
Visible:1
contextual:none
Position
{
AutoHeight:""
AutoWidth:""
Height:44
HeightPercent:""
Left:158
Top:0
Width:384
WidthPercent:""
}
@
{
Html
{
BeforeCreate:""
Caption:""
Code:"
<% echo(oApp.DisplayName+\"(\"+oApp.Name+\")&nbsp;版本:\"+oApp.Ver); %>
"
Name:Html3
Position
{
Height:20
Left:33
Top:10
Width:80
}
}
}
}
}
}
BjRow
{
BeforeCreate:""
Caption:""
Enabled:1
Expr:""
ExtProp:""
Name:""
Visible:1
contextual:none
Position
{
AutoHeight:""
AutoWidth:""
Height:58
HeightPercent:""
Left:0
Top:44
Width:542
WidthPercent:""
}
@
{
BjCell
{
BeforeCreate:""
Caption:""
ColSpan:1
Enabled:1
ExtProp:""
Name:""
RowSpan:1
Spaned:0
Visible:1
contextual:none
Position
{
AutoHeight:""
AutoWidth:""
Height:58
HeightPercent:""
Left:0
Top:0
Width:158
WidthPercent:""
}
@
{
Html
{
BeforeCreate:""
Caption:启动者
Code:"<b>启动者</b>"
Name:Html2
Position
{
Height:20
Left:30
Top:20
Width:80
}
}
}
}
BjCell
{
BeforeCreate:""
Caption:""
ColSpan:1
Enabled:1
ExtProp:""
Name:""
RowSpan:1
Spaned:0
Visible:1
contextual:none
Position
{
AutoHeight:""
AutoWidth:""
Height:58
HeightPercent:""
Left:158
Top:0
Width:384
WidthPercent:""
}
@
{
Html
{
BeforeCreate:""
Caption:""
Code:"<%
{
	var str=\"\";
	if( oCurProcess.ParentProcessID <> \"\" )
	{
		str = \"父进程：\"+oCurProcess.ParentProcessID+\"&nbsp;父线程：\"+oCurProcess.ParentThreadID;
		var oParentProcess = staticcall(\"Workflow.Process.Load\",oCurProcess.ParentProcessID);
		var oParentThread = staticcall(\"Workflow.Thread.Load\",oCurProcess.ParentThreadID);
		str += \"<br>流程：\"+oParentProcess.AppName;
		str += \"<br>启动环节：\";//fix me later 根据活动得到环节名+oCurProcess.parentsegment;
	}
	else
	{
		if( 0 <> int(oCurProcess.UserID) )
		{
			var obj = (new dao.table(\"t_user\")).Single(\"select alias,loginname from t_user where id=?\",oCurProcess.UserID);
			str = obj.alias+\"(\"+obj.loginname+\")\";
		}
		else
		{
			str += \"定时器：\"+oCurProcess.StartTime;
		}
	}
	echo(str);
}
%>"
Name:Html4
Position
{
Height:20
Left:32
Top:18
Width:80
}
}
}
}
}
}
BjTable
{
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:""
Visible:1
border:1
condensed:0
forsthead:0
hover:1
striped:1
Position
{
AutoHeight:""
AutoWidth:""
Height:47
HeightPercent:""
Left:0
Top:102
Width:542
WidthPercent:""
}
@
{
Cell
{
BeforeCreate:""
Caption:""
ColSpan:1
Enabled:1
Name:""
RowSpan:1
Spaned:0
Visible:1
Position
{
AutoHeight:""
AutoWidth:""
Height:47
HeightPercent:""
Left:0
Top:0
Width:158
WidthPercent:""
}
@
{
Html
{
BeforeCreate:""
Caption:启动时间
Code:"<b>启动时间</b>"
Name:Html2
Position
{
Height:20
Left:30
Top:14
Width:80
}
}
}
}
Cell
{
BeforeCreate:""
Caption:""
ColSpan:1
Enabled:1
Name:""
RowSpan:1
Spaned:0
Visible:1
Position
{
AutoHeight:""
AutoWidth:""
Height:47
HeightPercent:""
Left:158
Top:0
Width:384
WidthPercent:""
}
@
{
Html
{
BeforeCreate:""
Caption:""
Code:"<% echo(oCurProcess.StartTime); %>"
Name:Html5
Position
{
Height:20
Left:32
Top:15
Width:80
}
}
}
}
}
}
BjTable
{
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:""
Visible:1
border:1
condensed:0
forsthead:0
hover:1
striped:1
Position
{
AutoHeight:""
AutoWidth:""
Height:41
HeightPercent:""
Left:0
Top:149
Width:542
WidthPercent:""
}
@
{
Cell
{
BeforeCreate:""
Caption:""
ColSpan:1
Enabled:1
Name:""
RowSpan:1
Spaned:0
Visible:1
Position
{
AutoHeight:""
AutoWidth:""
Height:41
HeightPercent:""
Left:0
Top:0
Width:158
WidthPercent:""
}
@
{
Html
{
BeforeCreate:""
Caption:状态
Code:"<b>状态</b>"
Name:Html2
Position
{
Height:20
Left:30
Top:13
Width:80
}
}
}
}
Cell
{
BeforeCreate:""
Caption:""
ColSpan:1
Enabled:1
Name:""
RowSpan:1
Spaned:0
Visible:1
Position
{
AutoHeight:""
AutoWidth:""
Height:41
HeightPercent:""
Left:158
Top:0
Width:384
WidthPercent:""
}
@
{
Html
{
BeforeCreate:""
Caption:""
Code:"<%
echo( staticcall(\"Workflow.Model.Process.StatusText\",oCurProcess.CurStatus) );
%>"
Name:Html6
Position
{
Height:20
Left:32
Top:12
Width:80
}
}
}
}
}
}
BjTable
{
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:""
ID:""
Name:""
Visible:1
border:1
condensed:0
forsthead:0
hover:1
striped:1
Position
{
AutoHeight:""
AutoWidth:""
Height:41
HeightPercent:""
Left:0
Top:190
Width:542
WidthPercent:""
}
@
{
Cell
{
BeforeCreate:""
Caption:""
ColSpan:1
Enabled:1
Name:""
RowSpan:1
Spaned:0
Visible:1
Position
{
AutoHeight:""
AutoWidth:""
Height:41
HeightPercent:""
Left:0
Top:0
Width:158
WidthPercent:""
}
@
{
Html
{
BeforeCreate:""
Caption:进程ID
Code:"<b>进程ID</b>"
Name:Html2
Position
{
Height:20
Left:30
Top:9
Width:80
}
}
}
}
Cell
{
BeforeCreate:""
Caption:""
ColSpan:1
Enabled:1
Name:""
RowSpan:1
Spaned:0
Visible:1
Position
{
AutoHeight:""
AutoWidth:""
Height:41
HeightPercent:""
Left:158
Top:0
Width:384
WidthPercent:""
}
@
{
Html
{
BeforeCreate:""
Caption:""
Code:"<%
echo( oCurProcess.ID );
%>"
Name:Html6
Position
{
Height:20
Left:32
Top:13
Width:80
}
}
}
}
}
}
}
}
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"style=\"margin-bottom:5px\""
ID:""
Name:Box1
TagName:""
Visible:1
Position
{
Height:67
Left:30
Top:702
Width:646
}
@
{
Html
{
BeforeCreate:""
Caption:"线程管理 -- head"
Code:"<div style=\"float:left;height:37px;width:130px;border-bottom:solid 3px RGB(252,139,1)\">
<h4>线程信息</h4>
</div>
<div style=\"margin-left:90px;height:37px;border-bottom:solid 3px RGB(73,106,182)\">

</div>"
Name:Html1
Position
{
Height:20
Left:20
Top:19
Width:172
}
}
}
}
Box
{
AfterCreate:""
BeforeCreate:""
Caption:""
Enabled:1
ExtProp:"style=\"margin-top:5px;margin-bottom:10px\""
ID:""
Name:Box1
TagName:""
Visible:1
Position
{
Height:79
Left:28
Top:783
Width:619
}
@
{
BjButton
{
BeforeCreate:""
Block:0
ButtonType:submit
Caption:强制终止
Enabled:1
Feedback:danger
ID:""
Inline:1
Name:BjButton1
Size:default
URL:""
URLParam:""
Visible:1
Position
{
Height:20
Left:17
Top:31
Width:80
}
Events
{
OnClick:"var aSelected = (new grid.Selected(\"\")).Values();
each(a,aSelected)
{
	staticcall(\"Workflow.Engine.Run.TerminateThread\",a,\"用户强行终止线程\");
}"
OnClientClick:""
}
}
BjButton
{
BeforeCreate:""
Block:0
ButtonType:submit
Caption:暂停
Enabled:1
Feedback:default
ID:""
Inline:1
Name:BjButton2
Size:default
URL:""
URLParam:""
Visible:1
Position
{
Height:20
Left:105
Top:31
Width:80
}
Events
{
OnClick:"var aSelected = (new grid.Selected(\"\")).Values();
each(a,aSelected)
{
	staticcall(\"Workflow.Engine.Run.PauseThread\",a,\"用户强行暂停线程\");
}"
OnClientClick:""
}
}
BjButton
{
BeforeCreate:""
Block:0
ButtonType:submit
Caption:继续
Enabled:1
Feedback:default
ID:""
Inline:1
Name:BjButton3
Size:default
URL:""
URLParam:""
Visible:1
Position
{
Height:20
Left:193
Top:31
Width:80
}
Events
{
OnClick:"var aSelected = (new grid.Selected(\"\")).Values();
each(a,aSelected)
{
	staticcall(\"Workflow.Engine.Run.ResumeThread\",a,\"\");
}"
OnClientClick:""
}
}
}
}
BjPanel
{
BeforeCreate:""
ExtProp:""
Name:BjPanel1
contextual:default
Position
{
Height:60
Left:30
Top:883
Width:171
}
@
{
BjTree
{
BeforeCreate:"var 线程节点 = 构造线程树(oCurProcess);"
CheckBox:""
ExtProp:""
FullRow:""
Name:BjTree1
NodeVar:线程节点
Position
{
Height:20
Left:38
Top:22
Width:80
}
}
}
}
}
}
}
}
}
}
EasyScript
{
Caption:得到线程树代码
Code:"public function GetThreadStatusColor(var nStatus)
{
	if( int(nStatus) >= const(\"Workflow.Model.Thread.异常暂停\") ) return \"RGB(243,171,50)\";
	
	switch(nStatus)
	{
	case const(\"Workflow.Model.Thread.运行中\"): return \"RGB(72,185,75)\";
	case const(\"Workflow.Model.Thread.并行等待\"): return \"RGB(18,11,155)\";
	case const(\"Workflow.Model.Thread.等待人工\"): return \"RGB(83,11,155)\";
	case const(\"Workflow.Model.Thread.等待子流程结束\"): return \"RGB(10,90,156)\";
	case const(\"Workflow.Model.Thread.结束等待\"): return \"RGB(119,193,196)\";
	case const(\"Workflow.Model.Thread.正常结束\"): return \"RGB(126,150,145)\";
	case const(\"Workflow.Model.Thread.异常结束\"): return \"RGB(197,135,80)\";
	default: return \"\";
	}
}

public function GetThreadCode(var oThread)
{
	var sColor = GetThreadStatusColor(oThread.status);
	var sReason = string(oThread.reason).Replace(\"\n\",\"<br>\");
	var str=
	[\"
	<li>
	<input style=\\"margin-right:4px;display:inline\\" type=\\"checkbox\\" name=\\"chk_\"+oThread.id+\"\\"  value=\\"\"+oThread.id+\"\\" />
	<span><a>\",oThread.segment,
	(sColor <> \"\" ? \"<span style=\\"color:\"+sColor+\"\\">\": \"\"),
	\"&nbsp;&nbsp;\",staticcall(\"Workflow.Model.Thread.StatusText\",oThread.status),
	(sColor <> \"\" ? \"</span>\" : \"\"),
	( int(oThread.status) >= const(\"Workflow.Model.Thread.异常暂停\") || int(oThread.status) == const(\"Workflow.Model.Thread.异常结束\") ? \"(\"+sReason+\")\" : \"\"),
	\"&nbsp;&nbsp;(\",oThread.id,\")\",
	\"</a></span>
	</li>
	\"];
	return str;
}

public function GetThreadTreeCode(var sProcessID,var sThreadID)
{
	var str=\"\";
	
	if( sThreadID == \"\" )
	{
		var oProcess = staticcall(\"Workflow.Model.Process.Load\",sProcessID);
		var oThread = oProcess.MainThread;
		str += \"<ul class=\\"nav nav-list\\">\";
		str += GetThreadCode(oThread);
		str += \"</ul>\";
	}
	else
	{
		
		var oThread = staticcall(\"Workflow.Model.Thread.Load\",sThreadID);
		var oChildren = oThread.Children;
		if( oChildren.Count > 0 )
		{
			str += \"<ul class=\\"nav nav-list\\">\";
			each(a,oThread.Children)
			{
				str += GetThreadCode(a);
				str += GetThreadTreeCode(sProcessID,a.id);
			}
			str += \"</ul>\";
		}
		
	}
	return str;
}"
CodeType:server
Name:EasyScript2
Position
{
Height:20
Left:116
Top:-35
Width:178
}
}
EasyScript
{
Caption:构造线程树
Code:"public function 构造线程树(var oProcess)
{
	var aThread = oProcess.LoadThreads();
	var oMainThread=null;
	each(a,aThread)
	{
		if( a.ID == oProcess.MainThreadID )
		{
			oMainThread = a;
			break;
		}
	}
	var oNode = new node();
	if( null <> oMainThread ) oNode.Add( 构造线程节点(oMainThread,aThread) );
	return oNode;
}

private function 构造线程节点(var oThread,var allThread)
{
	var sName,sID,sDisplayName,sUrl;
	var index=0;
	var iCount = allThread.Count;
	for(var i=0;i<iCount;i++)
	{
		if( oThread == allThread[i] )
		{
			index = i;
			break;
		}
	}
	sName = \"线程\"+index;
	sID = oThread.ID;
	sDisplayName = sName;
	sUrl = \"\";
	var oNode = new node();
	oNode.n = sName;
	oNode.d = sDisplayName;
	oNode.id = sID;
	oNode.u = sUrl;
	oNode.Thread = oThread;
	each(a,allThread)
	{
		if( a.ParentThreadID == oThread.ID )
		{
			oNode.Add( 构造线程节点(a,allThread) );
		}
	}
	return oNode;
}"
CodeType:server
Name:EasyScript3
Position
{
Height:20
Left:311
Top:-37
Width:80
}
}
}
}
